version: '3'
services:
  tor:
    networks:
      - core-infra
    build:
      context: ./scripts/tor
      dockerfile: Dockerfile
    image: ${TOR_IMAGE_ID}
    expose:
      - 9050
      - 9080
      - 9051
    ports:
      - "9050:9050"
      - "9051:9051"
      - "9080:9080"
    command: ["./launch_tor.sh"]
    deploy:
      mode: replicated
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 10
        window: 180s
      placement:
        constraints:
          - node.labels.stateless == true

  clarifai_uploader_service:
    depends_on:
      - tor
    build: .
    image: ${LOST_GRANDMA_IMAGE_ID}
    env_file:
      - staging.env
    networks:
      - core-infra
    command: ["./workers/clarifai_services/launch.sh"]
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 100
        window: 180s
      placement:
        constraints:
          - node.labels.stateless == true
  api:
    depends_on:
      - tor
    build: .
    image: ${LOST_GRANDMA_IMAGE_ID}
    env_file:
      - staging.env
    networks:
      - core-infra
    command: ["./workers/clarifai_services/launch.sh"]
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 100
        window: 180s
      placement:
        constraints:
          - node.labels.stateless == true

networks:  
  core-infra:
    external: true